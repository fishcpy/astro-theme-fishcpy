import{c as l}from"./config.4CXhSDGS.js";class d{constructor(){this.initialized=!1,this.config=null,this.retryCount=0,this.maxRetries=10}async init(){this.initialized||(this.config={envId:l.twikoo.envId},await this.waitForTwikoo(),this.updateAllVisitors(),this.initialized=!0)}waitForTwikoo(){return new Promise((i,t)=>{const o=()=>{typeof window<"u"&&window.twikoo?i():this.retryCount<this.maxRetries?(this.retryCount++,setTimeout(o,500)):t(new Error("Twikoo failed to load"))};o()})}async updateAllVisitors(){const i=document.querySelectorAll('[id^="twikoo_visitors_"]');if(i.length===0)return;const t=[],o=new Map;for(const e of i){const n=this.extractUrlFromId(e.id);t.push(n),o.set(n,e)}try{const e=await this.getVisitorCounts(t);for(const[n,r]of Object.entries(e)){const s=o.get(n);s&&(s.textContent=r.toString())}}catch{for(const n of i)try{const r=this.extractUrlFromId(n.id),s=await this.getSingleVisitorCount(r);n.textContent=s.toString()}catch{n.textContent="0"}}}extractUrlFromId(i){let t=i.replace("twikoo_visitors_","").replace(/_/g,"/");return t.startsWith("/")||(t="/"+t),t}async getVisitorCounts(i){if(!window.twikoo)throw new Error("Twikoo not available");const t={};for(const o of i)try{const e=await this.getSingleVisitorCount(o);t[o]=e}catch{t[o]=0}return t}async getSingleVisitorCount(i){if(!window.twikoo)throw new Error("Twikoo not available");try{const t=await fetch(this.config.envId,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({event:"COUNTER_GET",url:i})});if(t.ok){const o=await t.json();if(o.data&&o.data.time!==void 0)return o.data.time;if(o.time!==void 0)return o.time}return 0}catch{return 0}}async updateVisitorForUrl(i){const t=`twikoo_visitors_${i.replace(/[^a-zA-Z0-9]/g,"_")}`,o=document.getElementById(t);if(o)try{const e=await this.getSingleVisitorCount(i);o.textContent=e.toString()}catch{}}}window.twikooVisitorManager=new d;function a(){window.twikooVisitorManager&&window.twikooVisitorManager.init().catch(c=>{})}document.addEventListener("DOMContentLoaded",()=>{setTimeout(a,3e3)});document.addEventListener("astro:page-load",()=>{setTimeout(a,2e3)});window.addEventListener("popstate",()=>{setTimeout(a,2e3)});
