---
import I18nKey from "../i18n/i18nKey";
import { i18n } from "../i18n/translation";
import MainGridLayout from "../layouts/MainGridLayout.astro";
---

<MainGridLayout title={i18n(I18nKey.friendsCircle)} description={i18n(I18nKey.friendsCircle)}>
    <div class="flex w-full rounded-[var(--radius-large)] overflow-hidden relative min-h-32">
        <div class="card-base z-10 px-9 py-6 relative w-full">
            <h1 class="text-4xl font-bold mb-6 text-neutral-900 dark:text-white">{i18n(I18nKey.friendsCircle)}</h1>
            
            <!-- 统计信息卡片 -->
            <div id="stats-container" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg p-4 text-white">
                    <div class="text-2xl font-bold" id="friends-num">-</div>
                    <div class="text-sm opacity-90">{i18n(I18nKey.friendsNum)}</div>
                </div>
                <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-lg p-4 text-white">
                    <div class="text-2xl font-bold" id="active-num">-</div>
                    <div class="text-sm opacity-90">{i18n(I18nKey.activeNum)}</div>
                </div>
                <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-lg p-4 text-white">
                    <div class="text-2xl font-bold" id="error-num">-</div>
                    <div class="text-sm opacity-90">{i18n(I18nKey.errorNum)}</div>
                </div>
                <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg p-4 text-white">
                    <div class="text-2xl font-bold" id="article-num">-</div>
                    <div class="text-sm opacity-90">{i18n(I18nKey.articleNum)}</div>
                </div>
            </div>

            <!-- 最后更新时间 -->
            <div class="mb-6 text-sm text-neutral-600 dark:text-neutral-400">
                <span>{i18n(I18nKey.lastUpdated)}: </span>
                <span id="last-updated">-</span>
            </div>

            <!-- 加载状态 -->
            <div id="loading" class="text-center py-8">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                <div class="mt-2 text-neutral-600 dark:text-neutral-400">{i18n(I18nKey.loading)}</div>
            </div>

            <!-- 错误状态 -->
            <div id="error" class="hidden text-center py-8">
                <div class="text-red-500 mb-4">
                    <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                    </svg>
                </div>
                <div class="text-neutral-600 dark:text-neutral-400 mb-4">{i18n(I18nKey.loadError)}</div>
                <button id="retry-btn" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                    {i18n(I18nKey.retry)}
                </button>
            </div>

            <!-- 文章列表 -->
            <div id="articles-container" class="hidden">
                <h2 class="text-2xl font-bold mb-4 text-neutral-800 dark:text-neutral-200">最新文章</h2>
                <div id="articles-list" class="space-y-4">
                    <!-- 文章将通过JavaScript动态加载 -->
                </div>
            </div>

            <!-- 无文章状态 -->
            <div id="no-articles" class="hidden text-center py-8">
                <div class="text-neutral-400 dark:text-neutral-600 mb-2">
                    <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                </div>
                <div class="text-neutral-600 dark:text-neutral-400">{i18n(I18nKey.noArticles)}</div>
            </div>
        </div>
    </div>
</MainGridLayout>

<script>
    interface StatisticalData {
        friends_num: number;
        active_num: number;
        error_num: number;
        article_num: number;
        last_updated_time: string;
    }

    interface ArticleData {
        title: string;
        created: string;
        link: string;
        author: string;
        avatar: string;
    }

    interface ApiResponse {
        statistical_data: StatisticalData;
        article_data: ArticleData[];
    }

    let isLoading = false;
    let hasInitialized = false;

    async function fetchFriendsCircleData(): Promise<ApiResponse | null> {
        try {
            const response = await fetch('https://fc.fis.ink/all.json', {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                    'Cache-Control': 'no-cache',
                },
                // 添加超时控制
                signal: AbortSignal.timeout(10000)
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            return data;
        } catch (error) {
            console.error('Failed to fetch friends circle data:', error);
            return null;
        }
    }

    function updateStatistics(stats: StatisticalData) {
        const friendsNum = document.getElementById('friends-num');
        const activeNum = document.getElementById('active-num');
        const errorNum = document.getElementById('error-num');
        const articleNum = document.getElementById('article-num');
        const lastUpdated = document.getElementById('last-updated');

        if (friendsNum) friendsNum.textContent = stats.friends_num.toString();
        if (activeNum) activeNum.textContent = stats.active_num.toString();
        if (errorNum) errorNum.textContent = stats.error_num.toString();
        if (articleNum) articleNum.textContent = stats.article_num.toString();
        if (lastUpdated) lastUpdated.textContent = stats.last_updated_time;
    }

    function renderArticles(articles: ArticleData[]) {
        const container = document.getElementById('articles-list');
        if (!container) return;
        
        container.innerHTML = '';

        if (articles.length === 0) {
            showNoArticles();
            return;
        }

        articles.forEach(article => {
            const articleElement = document.createElement('div');
            articleElement.className = 'bg-white dark:bg-neutral-800 rounded-lg p-4 shadow-sm border border-neutral-200 dark:border-neutral-700 hover:shadow-md transition-shadow';
            
            // 转义HTML内容防止XSS
            const escapeHtml = (text: string) => {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            };
            
            articleElement.innerHTML = `
                <div class="flex items-start gap-4">
                    <img src="${escapeHtml(article.avatar)}" alt="${escapeHtml(article.author)}" class="w-12 h-12 rounded-full object-cover flex-shrink-0" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDgiIGhlaWdodD0iNDgiIHZpZXdCb3g9IjAgMCA0OCA0OCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjQiIGN5PSIyNCIgcj0iMjQiIGZpbGw9IiNGM0Y0RjYiLz4KPHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4PSIxMiIgeT0iMTIiPgo8cGF0aCBkPSJNMTIgMTJDMTQuMjA5MSAxMiAxNiAxMC4yMDkxIDE2IDhDMTYgNS43OTA5IDE0LjIwOTEgNCAxMiA0QzkuNzkwODYgNCA4IDUuNzkwOSA4IDhDOCAxMC4yMDkxIDkuNzkwODYgMTIgMTIgMTJaIiBmaWxsPSIjOUNBM0FGIi8+CjxwYXRoIGQ9Ik0xMiAxNEM5LjMzIDEzLjk5IDcuMDEgMTUuNzQgNiAxOC4yNFYyMEgxOFYxOC4yNEMxNi45OSAxNS43NCAxNC42NyAxMy45OSAxMiAxNFoiIGZpbGw9IiM5Q0EzQUYiLz4KPC9zdmc+Cjwvc3ZnPgo='">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="font-medium text-neutral-900 dark:text-white">${escapeHtml(article.author)}</span>
                            <span class="text-sm text-neutral-500 dark:text-neutral-400">${escapeHtml(article.created)}</span>
                        </div>
                        <h3 class="text-lg font-medium text-neutral-800 dark:text-neutral-200 mb-2 line-clamp-2">
                            <a href="${escapeHtml(article.link)}" target="_blank" rel="noopener noreferrer" class="hover:text-blue-600 dark:hover:text-blue-400 transition-colors">
                                ${escapeHtml(article.title)}
                            </a>
                        </h3>
                    </div>
                    <a href="${escapeHtml(article.link)}" target="_blank" rel="noopener noreferrer" class="flex-shrink-0 p-2 text-neutral-400 hover:text-blue-600 dark:hover:text-blue-400 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                        </svg>
                    </a>
                </div>
            `;
            
            container.appendChild(articleElement);
        });

        const articlesContainer = document.getElementById('articles-container');
        if (articlesContainer) {
            articlesContainer.classList.remove('hidden');
        }
    }

    function showLoading() {
        const loading = document.getElementById('loading');
        const error = document.getElementById('error');
        const articlesContainer = document.getElementById('articles-container');
        const noArticles = document.getElementById('no-articles');

        if (loading) loading.classList.remove('hidden');
        if (error) error.classList.add('hidden');
        if (articlesContainer) articlesContainer.classList.add('hidden');
        if (noArticles) noArticles.classList.add('hidden');
    }

    function showError() {
        const loading = document.getElementById('loading');
        const error = document.getElementById('error');
        const articlesContainer = document.getElementById('articles-container');
        const noArticles = document.getElementById('no-articles');

        if (loading) loading.classList.add('hidden');
        if (error) error.classList.remove('hidden');
        if (articlesContainer) articlesContainer.classList.add('hidden');
        if (noArticles) noArticles.classList.add('hidden');
    }

    function showNoArticles() {
        const loading = document.getElementById('loading');
        const error = document.getElementById('error');
        const articlesContainer = document.getElementById('articles-container');
        const noArticles = document.getElementById('no-articles');

        if (loading) loading.classList.add('hidden');
        if (error) error.classList.add('hidden');
        if (articlesContainer) articlesContainer.classList.add('hidden');
        if (noArticles) noArticles.classList.remove('hidden');
    }

    async function loadData() {
        if (isLoading) return;
        
        isLoading = true;
        showLoading();

        const data = await fetchFriendsCircleData();
        
        if (data) {
            updateStatistics(data.statistical_data);
            renderArticles(data.article_data);
            const loading = document.getElementById('loading');
            if (loading) loading.classList.add('hidden');
        } else {
            showError();
        }
        
        isLoading = false;
    }

    function initializePage() {
        if (hasInitialized) return;
        
        // 绑定重试按钮事件
        const retryBtn = document.getElementById('retry-btn');
        if (retryBtn) {
            retryBtn.addEventListener('click', loadData);
        }
        
        hasInitialized = true;
        loadData();
    }

    function checkAndInitialize() {
        // 检查是否在朋友圈页面
        if (window.location.pathname === '/circle/' || window.location.pathname === '/circle') {
            // 重置初始化状态，确保每次进入页面都能重新加载
            hasInitialized = false;
            // 延迟一点时间确保DOM完全加载
            setTimeout(initializePage, 100);
        }
    }

    // 页面加载时初始化
    document.addEventListener('DOMContentLoaded', checkAndInitialize);

    // 监听 Astro 的页面导航事件
    document.addEventListener('astro:page-load', checkAndInitialize);

    // 监听浏览器的 popstate 事件（后退/前进按钮）
    window.addEventListener('popstate', checkAndInitialize);

    // 立即检查一次（防止脚本加载较晚的情况）
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', checkAndInitialize);
    } else {
        checkAndInitialize();
    }
</script>

<style>
    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
</style>