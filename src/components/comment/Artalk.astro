---
interface Props {
	path: string;
}

import { commentConfig } from "@/config";

const config = {
	el: "#artalk",
	pageKey: Astro.props.path,
	pageTitle: "",
	server: commentConfig.artalk?.server || "http://localhost:8080",
	site: commentConfig.artalk?.site || "fishcpy的小破站",
	darkMode: commentConfig.artalk?.darkMode || "auto",
};
---

<!-- Artalk 统计信息 -->
<div class="mb-4 text-sm text-gray-600 dark:text-gray-400 flex gap-4">
	<span>浏览量：<span class="artalk-pv-count">-</span></span>
	<span>评论数：<span class="artalk-comment-count">-</span></span>
</div>
<!-- Artalk 评论区 -->
<div id="artalk"></div>
<script define:vars={{ config }}>
  function loadArtalk() {
    console.log('loadArtalk function called');
    
    // 加载CSS
    const cssLink = document.createElement('link');
    cssLink.rel = 'stylesheet';
    cssLink.href = 'https://artalk.fis.ink/dist/Artalk.css';
    document.head.appendChild(cssLink);
    
    // 加载JS
    const script = document.createElement('script');
    script.src = 'https://artalk.fis.ink/dist/Artalk.js';
    script.defer = true;
    script.onload = () => {
      console.log('Artalk script loaded, initializing...');
      
      try {
        const artalk = Artalk.init({
          el: config.el,
          pageKey: config.pageKey,
          pageTitle: config.pageTitle || document.title,
          server: config.server,
          site: config.site,
          darkMode: config.darkMode,
        });
        console.log('Artalk initialized successfully');
        
        // 等待Artalk完全加载后更新统计数据
        setTimeout(() => {
          updateStats();
          // 设置定期更新统计数据
          setInterval(updateStats, 30000); // 每30秒更新一次
        }, 1000);
      } catch (error) {
        console.error('Artalk initialization failed:', error);
      }
    };
    
    script.onerror = (error) => {
      console.error('Artalk script loading failed:', error);
    };
    
    document.body.appendChild(script);
  }
  
  // 更新统计数据的函数
  function updateStats() {
    console.log('Updating Artalk stats...');
    
    // 获取浏览量
    const pvElement = document.querySelector('.artalk-pv-count');
    const commentCountElement = document.querySelector('.artalk-comment-count');
    
    if (pvElement || commentCountElement) {
      // 使用Artalk的API获取统计数据
      fetch(`${config.server}/api/v2/stat?site_name=${encodeURIComponent(config.site)}&page_key=${encodeURIComponent(config.pageKey)}`)
        .then(response => response.json())
        .then(data => {
          console.log('Stats data received:', data);
          if (pvElement && data.pv !== undefined) {
            pvElement.textContent = data.pv;
          }
          if (commentCountElement && data.comment_count !== undefined) {
            commentCountElement.textContent = data.comment_count;
          }
        })
        .catch(error => {
          console.error('Failed to fetch stats:', error);
        });
    }
  }
  
  // 监听加载评论事件
  document.addEventListener("loadComment", () => {
    loadArtalk();
  }, { once: true });
  
  // 页面加载完成后自动加载Artalk
  window.addEventListener('DOMContentLoaded', () => {
    console.log('DOMContentLoaded event triggered for Artalk');
    if (!document.querySelector('script[src*="Artalk.js"]')) {
      console.log('Artalk not loaded yet, loading now...');
      loadArtalk();
    }
  });
  
  console.log('Artalk component initialized');
</script>